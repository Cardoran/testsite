<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pie Chart Example</title>
  <style>
    h1 {text-align: center;}
    body { font-family: Arial, sans-serif; margin: 20px; }
    .chart-container { width: 800px; height: 400px; margin: 20px auto; }
    .button-container { width: 800px; margin: 20px auto; }
    button { padding: 10px 15px; background: #007BFF; color: white; border: none; cursor: pointer; }
  </style>
</head>
<body>
  <h1>Pie Chart Example</h1>
  <button id="fetchButton">Fetch Data Now</button>
  <div class="button-container">
    <label for="start">Start Date:</label>
    <input type="date" id="start" name="start">
  
    <label for="end" style="margin-left: 10px;">End Date:</label>
    <input type="date" id="end" name="end">
  
    <button id="updateRangeButton" style="margin-left: 10px;">Update Range</button>
  </div>
  <div class="chart-container">
    <canvas id="pieChart" width="100%"></canvas>
    <canvas id="graphChart" width="100%"></canvas>
  </div>

  <!-- Include Chart.js from CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
    function setDefaultDates() {
      const endDate = new Date(); // Current date
      const startDate = new Date();
      startDate.setDate(endDate.getDate() - 7); // 5 days before current date

      // Format dates as YYYY-MM-DD (required for input[type="date"])
      const formatDate = (date) => date.toISOString().split('T')[0];

      document.getElementById('start').value = formatDate(startDate);
      document.getElementById('end').value = formatDate(endDate);

      fetchData();
    }

    const canvas = document.getElementById('canvas');
    const context = canvas.getContext('2d');

    // resize the canvas to fill browser window dynamically
    window.addEventListener('resize', resizeCanvas, false);
          
    function resizeCanvas() {
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
                  
      /**
       * Your drawings need to be inside this function otherwise they will be reset when 
       * you resize the browser window and the canvas goes will be cleared.
       */
      // drawStuff(); 
    }
    
    resizeCanvas();
    

    // Call this function when the page loads
    window.addEventListener('DOMContentLoaded', setDefaultDates);
  </script>

  <script>
    let pieChart;
    let graphChart;

    // Function to fetch and plot data
    async function collectData() {
      const startInput = document.getElementById('start').value.substring(0,16).replace("T"," ");
      const endInput = document.getElementById('end').value.substring(0,16).replace("T"," ");
      console.log(startInput,endInput);
      // await fetch('/updateLatestData', {startDate:startInput, endDate:endInput});
      await fetch(`updateLatestData?startDate=${startInput}&endDate=${endInput}`);
      fetchPieData();
      fetchGraphData();
    }
    async function fetchPieData() {
      try {
        const response = await fetch('/api/piedata');
        const piedata = await response.json();

        // Destroy previous chart if it exists
        if (pieChart) {
          pieChart.destroy();
        }

        const customTextPlugin = {
          id: 'customText',
          afterDraw: (chart) => {
            const ctx = chart.ctx;
            const chartArea = chart.chartArea; // Get the chart area

            // Calculate the center of the doughnut
            const centerX = (chartArea.left + chartArea.right) / 2;
            const centerY = (chartArea.top + chartArea.bottom) / 2;

            ctx.save();
            ctx.font = 'bold 16px Arial';
            ctx.fillStyle = 'blue';
            ctx.textAlign = 'center';
            ctx.fillText(piedata.emissions, centerX, centerY);
            ctx.fillText(piedata.row_time, centerX, centerY + 25);
            ctx.restore();
          }
        };

        // Create a new pie chart
        const ctx = document.getElementById('pieChart').getContext('2d');
        pieChart = new Chart(ctx, {
          type: 'doughnut',
          data: piedata,
          options: {
            responsive: false,
            animation: true,
            plugins: {
              legend: {
                display: false,
                position: 'right'
              },
              title: {
                display: true,
                text: 'Power Generation'
              }
            }
          },
          plugins: [customTextPlugin] // Register the custom plugin
        });
      } catch (error) {
        console.error('Error:', error);
      }
    }
    async function fetchGraphData() {
      try {
        const response = await fetch('/api/graphdata');
        const graphdata = await response.json();

        console.log(graphChart)
        if (graphChart) {
          graphChart.destroy();
        }

        Chart.Tooltip.positioners.cursor = function(chartElements, coordinates) {
          return coordinates;
        };
        const ctx2 = document.getElementById('graphChart').getContext('2d');
        graphChart = new Chart(ctx2, {
          type: 'line',
          data: graphdata,
          options: {
            responsive: true,
            radius: 0,
            interaction: {
              mode: 'nearest',
              axis: 'x',
              intersect: false,
              position: 'cursor',
            },
            scales: {
              x: {
                ticks: {
                  autoSkip: false,
                  callback: function (value, index, values) {
                    // Only show label if it's the first timestamp of the day
                    const date = this.getLabelForValue(value).split(" ");
                    return date[1] == "00:00" ? date[0] : '';
                  }
                },
                title: {
                  display: true,
                  text: 'time'
                }
              },
              y: {
                stacked: true,
                title: {
                  display: true,
                  text: 'power'
                }
              }
            }
          }
        });
      } catch (error) {
        console.error('Error:', error);
      }
    }
    function fetchData() {
      collectData();
      // fetchPieData();
      // fetchGraphData();
    }

    // Fetch data immediately
    // fetchData();

    // Fetch data on button click
    document.getElementById('fetchButton').addEventListener('click', fetchData);
    document.getElementById('updateRangeButton').addEventListener('click', fetchData);
  </script>
</body>
</html>
